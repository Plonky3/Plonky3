use itertools::Itertools;
use p3_field::PrimeField;
use p3_mersenne_31::Mersenne31;
use p3_symmetric::permutation::{ArrayPermutation, CryptographicPermutation, MDSPermutation};

pub struct MDSMatrixNaive<F: PrimeField, const WIDTH: usize> {
    matrix: [[F; WIDTH]; WIDTH],
}

impl<F: PrimeField, const WIDTH: usize> CryptographicPermutation<[F; WIDTH]>
    for MDSMatrixNaive<F, WIDTH>
{
    fn permute(&self, input: [F; WIDTH]) -> [F; WIDTH] {
        let mut output = [F::ZERO; WIDTH];
        for (i, row) in self.matrix.iter().enumerate() {
            for (j, &x) in row.iter().enumerate() {
                output[i] += input[j] * x;
            }
        }
        output
    }
}

impl<F: PrimeField, const WIDTH: usize> ArrayPermutation<F, WIDTH> for MDSMatrixNaive<F, WIDTH> {}

impl<F: PrimeField, const WIDTH: usize> MDSPermutation<F, WIDTH> for MDSMatrixNaive<F, WIDTH> {}

// Generated with SageMath, using the get_mds_matrix function from the Rescue-Prime paper.
const RESCUE_PRIME_M31_WIDTH_8_MDS_MATRIX: [[u32; 8]; 8] = [
    [
        560144411, 702794841, 13543219, 1018969369, 1356371468, 70026149, 572157038, 960800,
    ],
    [
        1578346836, 1822832766, 1424192868, 873513001, 126758172, 1817670158, 655791960, 290828828,
    ],
    [
        195480960, 525152708, 445445282, 1450979265, 1292133817, 458162690, 1506025853, 569070367,
    ],
    [
        722179127, 323626339, 1200667897, 1546823282, 936163336, 1537801236, 229462001, 2093211371,
    ],
    [
        1156710667, 385687518, 379472232, 647417000, 1326732179, 1569925404, 351908287, 624597655,
    ],
    [
        161226354, 949361260, 574654437, 750490998, 1926636771, 975176490, 1631226495, 1621161784,
    ],
    [
        1002268512, 886716372, 1771627482, 1205506762, 1500125056, 2044577387, 1292145010,
        1034451655,
    ],
    [
        1109918314, 1053383964, 839387689, 2142499513, 1384812401, 101434350, 45217535, 1913280823,
    ],
];

const RESCUE_PRIME_M31_WIDTH_12_MDS_MATRIX: [[u32; 12]; 12] = [
    [
        393510438, 1551127396, 483002673, 1998957569, 1025079885, 115511964, 530280900, 38887577,
        968830049, 867935715, 457412870, 159397553,
    ],
    [
        887417768, 1247152123, 901254977, 41298575, 1972926317, 355505148, 1941187090, 300649654,
        1621413537, 64078783, 152059507, 1252474757,
    ],
    [
        789111372, 1644292216, 827410594, 633544830, 866727892, 187368002, 859641107, 1844057018,
        1025405911, 1647701750, 896353635, 1663287556,
    ],
    [
        877217122, 771776405, 1897352192, 939533479, 2117524579, 73680895, 748985210, 2014086892,
        911795180, 590857219, 2055837903, 2033738454,
    ],
    [
        1479701527, 1591866391, 1566866394, 8097772, 1808980725, 1348622804, 380717004, 944758805,
        834726449, 274506378, 1952001211, 694056423,
    ],
    [
        1464717785, 803202208, 1907333667, 266282052, 409164945, 46668139, 349418342, 1496524209,
        442571369, 2012651933, 1251999779, 286883808,
    ],
    [
        727408688, 1200833410, 1171836913, 1342068543, 1082452198, 864452523, 1821954550,
        322200912, 95288958, 1123162214, 1799481487, 1333761487,
    ],
    [
        571041182, 368833828, 1719311092, 2011856060, 552381640, 347665507, 994837143, 1308001216,
        546982247, 179609896, 2128984756, 7913669,
    ],
    [
        220705735, 491768285, 325906589, 2019630714, 1821441508, 342031772, 1353208203, 1410877468,
        1829430422, 1862532842, 761361197, 446007148,
    ],
    [
        547901971, 714883105, 652487947, 72998626, 1008787227, 2108763267, 144299979, 2020998628,
        999912110, 1519198775, 455535207, 491651394,
    ],
    [
        1132026776, 1016850571, 1094787390, 618376038, 1759032721, 1043910317, 606781403,
        924529084, 716329221, 463611045, 161183760, 1199999910,
    ],
    [
        352826408, 1982885719, 290966869, 170743739, 440083328, 1793025216, 504066583, 1422133598,
        943022435, 2923038, 462459765, 224797891,
    ],
];

fn u32_matrix_to_m31_matrix<const SIZE: usize>(
    matrix: [[u32; SIZE]; SIZE],
) -> [[Mersenne31; SIZE]; SIZE] {
    matrix
        .iter()
        .map(|row| {
            row.iter()
                .map(|&x| Mersenne31::from_canonical_u32(x))
                .collect_vec()
                .try_into()
                .unwrap()
        })
        .collect_vec()
        .try_into()
        .unwrap()
}

pub fn rescue_prime_m31_width_8_mds_matrix() -> MDSMatrixNaive<Mersenne31, 8> {
    MDSMatrixNaive {
        matrix: u32_matrix_to_m31_matrix(RESCUE_PRIME_M31_WIDTH_8_MDS_MATRIX),
    }
}

pub fn rescue_prime_m31_width_12_mds_matrix() -> MDSMatrixNaive<Mersenne31, 12> {
    MDSMatrixNaive {
        matrix: u32_matrix_to_m31_matrix(RESCUE_PRIME_M31_WIDTH_12_MDS_MATRIX),
    }
}
